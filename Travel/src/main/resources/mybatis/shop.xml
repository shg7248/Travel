<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="shop.model.Shop">
	<select id="Search" resultType="SearchBean">
		select a.anum, a.name, a.addr, r.price, a.image from accom a
		left outer join room r
		on a.anum = r.anum
		where 1 = 1
		<if test="fac2 != null">
		and a.anum in(
			select anum from(
				select anum, cnum, regexp_substr(fac2, '[^,]+', 1, level) fac2
				from accom a
				<![CDATA[connect by level <= regexp_count(fac2, '[^,]+')]]>
				and prior a.cnum = a.cnum
				and prior dbms_random.value is not null
			) 
			where fac2 in (select regexp_substr(#{fac2}, '[^,]+', 1, level)
			from dual
			<![CDATA[connect by level <= (select regexp_count(#{fac2}, '[^,]+') from dual))]]>
			group by anum
			having count(anum) = (select regexp_count(#{fac2}, '[^,]+') from dual)
		)
		</if>
		<if test="fac1 != null">
		and a.anum in(
			select anum from(
				select anum, cnum, regexp_substr(fac1, '[^,]+', 1, level) fac2
				from accom a
				<![CDATA[connect by level <= regexp_count(fac1, '[^,]+')]]>
				and prior a.cnum = a.cnum
				and prior dbms_random.value is not null
			) 
			where fac2 in (select regexp_substr(#{fac1}, '[^,]+', 1, level)
			from dual
			<![CDATA[connect by level <= (select regexp_count(#{fac1}, '[^,]+') from dual))]]>
			group by anum
			having count(anum) = (select regexp_count(#{fac1}, '[^,]+') from dual)
		)
		</if>
	</select>
	
	<select id="GetReserveInfoByRnum" parameterType="hashmap" resultType="ReserveBean">
		select a.name as aname, 
		r.name as rname, 
		a.addr, 
		r.price,
		<![CDATA[to_char(to_date(#{start}, 'yyyyMMdd'), 'MM"월"dd"일"') as startDate,]]>
		<![CDATA[to_char(to_date(#{end}, 'yyyyMMdd'), 'MM"월"dd"일"') as endDate,]]>
		to_date(#{end}, 'yyyyMMdd') - to_date(#{start}, 'yyyyMMdd') as totalDate
		from room r
		inner join accom a
		on r.anum = a.anum
		where r.rnum = #{rnum}
	</select>
</mapper>